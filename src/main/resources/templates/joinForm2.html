<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>회원가입</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <style>

        a{
            text-decoration: none;
            color: black;
        }

        #contents{
            width: 100%;
        }

        .container {
            width:80%;
        }


        #loginBtn{
            transition: 1s;
        }

        #loginBtn:hover{
            background: #ffff;
            border: 1px solid blue;
            color: black;
        }

        a{
            text-decoration: none;
            color: black;
        }


        #contents{
            width: 100%;
        }

        #outer{
            width: 65%;
            height: 10%;
            background: #FFF8ED;
            border-radius: 5px;
            border: 2px solid #F4E0C1;
            margin-bottom:  10px;
        }

        .current{
            color: #FE0000;
        }

        .signup-form {
            background-color:rgba(244, 244, 244, 1);
            width:75%;
            min-width: 480px;
            min-height:300px;
            margin:0 auto;
            margin-bottom:100px;
            border: 1px solid rgba(217, 217, 217, 1);
            border-radius: 15px;
          }
        
        .cert-me-btn {
            width: 150px;
            height:45px;
            border:none;
            font-size:15px;
            margin:25px;
            color:white;
            border-radius: 14px;
            background-color: rgba(255, 126, 126, 1);
            margin-bottom:50px;
        }

        #input-box {
            width:97%; 
            height:200px; 
            margin:10px;
            border:1px solid rgba(217, 217, 217, 1);
            border-radius:15px;
            font-size:13px;
            padding:15px;
            overflow:auto;
            text-align:left;
            background-color: white;
        }

       .bold-title {
        font-weight:bolder;
        font-size:12px;
        margin:0;
       }
        
       .join-input {
        width:100%;
        height:40px;
        margin: 10px 0px;
           padding: 5px;
        border:none;
        outline: none;
        border-radius: 4px;
        border-bottom:1px solid #D9D9D9;
           background: #ffff;
        display:inline-block;
       }

       .check-btn {
        height:40px;
        margin:8px 0px;
        border:none;
        border-radius: 7px;
        background-color: rgba(256, 126, 126, 1);
        color:white;
        display:inline-block;
       }

       .btnl{
           width: 10rem;
       }

       .signForm{
           width: 95%;
           height: 95%;
           margin: 0 auto;
           padding-top: 3%;
       }

        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        #inputToken{
            width: 60%;
            margin-right: 1%;
        }

        #auth{
            width: 38%;
            float: right;
        }

        #inputName{
            width: 49%;
            margin-right: 1%;
        }


        #cal{
            width: 49%;
            margin-right: 1%;
        }


        #joinBtn{
            width: 60%;
        }


        #loadingImg{
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            position: fixed;
            display: block;
            opacity: 0.8;
            background: white;
            z-index: 99;
            text-align: center;
        }

        #loadingImg > img{
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%,-50%);
            z-index: 100;
        }

        .birth{
            width: 31%;
        }

        #date{
            width: 5%;
        }

        input[type=date]::-webkit-datetime-edit-text {
            -webkit-appearance: none;
            display: none;
        }
        input[type=date]::-webkit-datetime-edit-month-field{
            -webkit-appearance: none;
            display: none;
        }
        input[type=date]::-webkit-datetime-edit-day-field {
            -webkit-appearance: none;
            display: none;
        }
        input[type=date]::-webkit-datetime-edit-year-field {
            -webkit-appearance: none;
            display: none;
        }

        .after-duple{
            display: none;
        }

        .after-auth{
            display: none;
        }

        #name{
            width: 50%;
        }

    </style>
</head>

<body>

    <div class="container">
    <header class="d-flex flex-wrap align-items-center justify-content-center justify-content-md-between py-3 mb-4 border-bottom">
        <div class="col-md-3 mb-2 mb-md-0">
            <a href="/" class="d-inline-flex link-body-emphasis text-decoration-none">
                GIVE
            </a>
        </div>

        <div class="col-md-3 text-end mr-3">
            <button id="loginBtn" type="button" class="btn btn-primary" onclick="location.replace('/view/users/login')">Login</button>
        </div>
    </header>
    </div>

    <section id="contents">

        <div class="container">
            <div class="row">
                <div class="col-3"></div>
                <div class="col-6">
                    <h4>회원가입</h4>
                </div>
                <div class="col-3"></div>
            </div>

            <div id="progress">

                <div class="container d-flex justify-content-center">
                    <div id="outer">
                        <div class="container" id="steps">
                            <p class="row justify-content-evenly">
                                <span id="step1" class="col-3 current">step01.</span>
                                <span class="col-1 next"> > </span>
                                <span id="step2" class="col-3">step02.</span>
                                <span class="col-1 next"> > </span>
                                <span id="step3" class="col-3">step03.</span>
                            </p>

                        </div>

                    </div>
                </div>

            </div>


            <div class="row">
                <div class="col-3" style="margin-left:15px; font-weight:bolder"></div>
                <div class="col-6"><p style="font-weight:bolder">회원 정보 입력</p></div>
            </div>


            <div class="container d-flex justify-content-center">

                <div class="signup-form">
                    <div class="signForm">
                    <form class="" action="/view/users/join" method="post" th:object="${form}">


                        <input id="inputEmail" th:field="*{email}" th:value="*{email}" class="join-input" type="email" placeholder="email Address"/>
                        <p id="dupleTrue"  text="이미 있는 email 입니다." class="text-danger d-none">duple</p>
                        <p id="dupleFalse"  text="사용 가능 합니다." class="text-success d-none">duple</p>
                        <button type="button" onclick="duplicateTest()" class="check-btn w-100">중복 검사</button>

                        <input type="text" th:field="*{name}" th:value="*{name}"class="join-input after-duple" placeholder="이름" id="name"/>
                        <input type="radio" th:field="*{gender}" class="btn-check after-duple" name="gender" id="gender1" value="M" autocomplete="off">
                        <label id="gender1Label" class="btn btnl btn-outline-success after-duple" for="gender1">남 자</label>
                        <input type="radio" class="btn-check after-duple" th:field="*{gender}" name="gender" id="gender2" value="F" autocomplete="off">
                        <label id="gender2Label" class="btn btnl btn-outline-danger after-duple" for="gender2">여 자</label>


                        <input id="inputToken" class="join-input d-none" type="number" maxlength="4" max="9999" placeholder="인증번호"/>

                        <button type="button" class="check-btn d-none" id="sendMailBtn" onclick="sendMail()">인증번호 보내기</button>
                        <button type="button" class="check-btn d-none" id="authBtn" onclick="auth()">인증 하기</button>

                        <input id="password" type="password" th:field="*{password}" onchange="isSame()" class="join-input after-auth" placeholder="비밀번호 입력"/>
                        <input id="checkpassword" type="password" class="join-input after-auth" onchange="isSame()" placeholder="비밀번호 재확인"/>
                        <p id="same" class="d-none"></p>

                        <input id="date" type="date" class="join-input after-auth" placeholder="" onchange="checkBirth()">
                        <input type="text" th:field="*{birthYear}" class="join-input birth after-auth" placeholder="생년" id="birthYear"  disabled/>
                        <input type="text" th:field="*{birthMonth}" class="join-input birth after-auth" placeholder="생월" id="birthMonth" disabled/>
                        <input type="text" th:field="*{birthDay}" class="join-input birth after-auth"  placeholder="생일" id="birthDay" disabled/>

                        <input type="tel" class="join-input after-auth" th:field="*{phone}" placeholder="전화번호 ex) 010-1234-5678" id="phone" />
                        <input type="text" class="join-input after-auth" th:field="*{address}" id="address" placeholder="주소"/>
                        <input type="text" class="join-input after-auth" th:field="*{addressDetail}" id="addressDetail" placeholder="상세주소"/>
                        <div id="joinBtnWrapper" class="row align-center justify-content-center d-none"><button id="joinBtn" type="button" onclick="join()" class="cert-me-btn">회원가입</button></div>
                    </form>
                    </div>
                </div>

            </div>


        </div>
    </section>

    <footer class="container footer">
        <hr>
        <div class="row justify-content-center text-center">
            <div class="col-3"></div>
            <div class="col-2"><a href="https://www.bloodinfo.net/knrcbs/bh/hous/srchBldHousList.do?mi=1059" class="customer-center-btn">헌혈의 집 찾기</a></div>
            <div class="col-2"><a href="https://www.bloodinfo.net/knrcbs/na/ntt/selectNttList.do?mi=1068&bbsId=1101" class="customer-center-btn">고객센터</a></div>
            <div class="col-2"><a href="https://www.bloodinfo.net/knrcbs/cm/cntnts/cntntsView.do?mi=1125&cntntsId=1014" class="customer-center-btn">레드커넥트</a></div>
            <div class="col-3 mt-5"></div>
        </div>
        <div class="row">
            <div class="col-3"></div>
            <hr>
            <div class="col-9"><p class="source_text">Copyright(C).2023.GIVE.All rights reserved.</p></div>
        </div>
    </footer>

    <div id="loadingImg">
        <img src="/img/loading.gif" alt="#">
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
            crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script th:inline="javascript">

        let TOKEN = null;

        const $inputEmail = document.getElementById('inputEmail');
        const $inputName = document.getElementById('name');
        const $gender1 = document.getElementById('gender1');
        const $gender2 = document.getElementById('gender2');
        const $birthY = document.getElementById('birthYear');
        const $birthM = document.getElementById('birthMonth');
        const $birthD = document.getElementById('birthDay');
        const $phone = document.getElementById('phone');
        const $address = document.getElementById('address');
        const $addressDetail = document.getElementById('addressDetail');
        const $authBtn = document.getElementById('authBtn');
        const $gender1Label = document.getElementById('gender1Label');
        const $gender2Label = document.getElementById('gender2Label');

        const $inputToken = document.getElementById('inputToken');

        const $LoadingImg = document.getElementById('loadingImg');
        const $sendMailBtn = document.getElementById('sendMailBtn');
        const $dupleTrue = document.getElementById('dupleTrue');
        const $dupleFalse = document.getElementById('dupleFalse');

        const $checkpassword = document.getElementById('checkpassword');
        const $password = document.getElementById('password');

        const $same = document.getElementById('same');

        const $date = document.getElementById('date');

        const $joinBtn = document.getElementById('joinBtn');
        const $joinBtnWrapper = document.getElementById('joinBtnWrapper');

        let dupleFlag = false;

        function setform(){
            const form = [[${form}]];
            form.email = $inputEmail.value;

            form.name = $inputName.value;

            if ($gender1.value != null){
                form.gender = $gender1.value;
            }else {
                form.gender = $gender2.value;
            }
            form.password = $password.value;
            form.birthYear = $birthY.value;
            form.birthMonth = $birthM.value;
            form.birthDay = $birthD.value;
            form.phone = $phone.value;
            form.address = $address.value;
            form.addressDetail = $addressDetail.value;

            return form;
        }


        $LoadingImg.hidden=true;

        $inputEmail.addEventListener('focusout', () =>{
            if(!email_check($inputEmail.value)){
                alert('email 형식이 아닙니다.');
                $inputEmail.value = '';
                $inputEmail.focus();
            }
        })

        $inputEmail.addEventListener('change',()=>{
            dupleFlag = false;
        })

        function duplicateTest(){
            const setForm = setform();
            fetch("http://localhost:8080/view/users/userCheck", {
                method: 'post',
                headers: {
                    'content-type': 'application/json'
                },
                body : JSON.stringify(setForm)
            }).then((response) => response.json())//읽어온 데이터를 json으로 변환
                .then((json) => {
                    if (json['duple']){
                        $dupleTrue.innerText = "이미 가입된 email 입니다.";
                        $dupleTrue.classList.remove('d-none');
                        $dupleFalse.classList.add('d-none');
                    }else{
                        $dupleFalse.innerText = "사용 가능한 email 입니다.";
                        $dupleFalse.classList.remove('d-none');
                        $dupleTrue.classList.add('d-none');
                        $sendMailBtn.innerText = '인증번호 보내기';
                        $sendMailBtn.classList.remove('d-none');

                        dupleFlag = true;

                        $inputName.classList.remove('after-duple');
                        $gender1.classList.remove('after-duple');
                        $gender2.classList.remove('after-duple');
                        $gender1Label.classList.remove('after-duple');
                        $gender2Label.classList.remove('after-duple');
                    }
                })


        }



        function auth(){
            if (TOKEN != null){
                if (TOKEN == $inputToken.value){
                    $authBtn.classList.add('d-none');
                    $inputToken.classList.add('d-none');
                    $sendMailBtn.classList.add('d-none');

                    Toast.fire({
                        icon: "success",
                        title: "인증 성공!"
                    });

                    $birthY.classList.remove('after-auth');
                    $birthM.classList.remove('after-auth');
                    $birthD.classList.remove('after-auth');
                    $phone.classList.remove('after-auth');
                    $password.classList.remove('after-auth');
                    $checkpassword.classList.remove('after-auth');
                    $address.classList.remove('after-auth');
                    $addressDetail.classList.remove('after-auth');
                    $date.classList.remove('after-auth');

                    $joinBtnWrapper.classList.remove('d-none');

                }else{
                    $sendMailBtn.innerText = '재 발급';
                    $sendMailBtn.classList.remove('d-none');

                    Toast.fire({
                        icon: "error",
                        title: "인증 실패!"
                    });

                }
            }

        }

        function sendMail(){

            $LoadingImg.hidden=false;

            const setForm = setform();

            let token = null;

            if(!$inputEmail.value){
                alert("Email 주소를 먼저 입력해 주세요.");
                $inputEmail.focus();
                return;
            }

            fetch("http://localhost:8080/view/email/sendmail", {
                method: 'post',
                headers: {
                    'content-type': 'application/json'
                },
                body : JSON.stringify(setForm)
            }).then((response) => response.json())//읽어온 데이터를 json으로 변환
                .then((json) => {
                    if (json){
                        token = json['token'];
                        TOKEN = token;
                        $sendMailBtn.classList.add('d-none');
                        $authBtn.classList.remove('d-none');
                    }
                })

            setTimeout(() => loadingImgHidden(), 5000);
            $inputToken.classList.remove('d-none');

        }

        function loadingImgHidden(){
            $LoadingImg.hidden=true;
        }

        function email_check(email) {

            var reg = /^[0-9a-zA-Z]([-_\.]?[0-9a-zA-Z])*@[0-9a-zA-Z]([-_\.]?[0-9a-zA-Z])*\.[a-zA-Z]{2,3}$/i;

            return reg.test(email);

        }

        $checkpassword.addEventListener('focus',() => {
            if(!$password.value){
                alert('비밀 번호를 입력하세요.');
                $password.focus();
            }
        })

        function isSame(){

            if($password.value.length < 6 || $checkpassword.value.length > 16){
                window.alert('비밀번호는 6글자 이상, 16글자 이하만 이용 가능합니다.');
                $password.value='';
                $checkpassword.value='';
                $password.focus();
                $same.classList.add('d-none');
            }

            if($password.value!='' && $checkpassword.value!=''){
                if($password.value==$checkpassword.value){
                    $same.innerHTML='비밀번호가 일치합니다.';
                    $same.style.color='green';
                    $same.classList.remove('d-none');
                    $checkpassword.style.border = '1px green solid';
                    $password.style.border = '1px green solid';
                }else{
                    $same.innerHTML='비밀번호가 일치하지 않습니다.';
                    $same.style.color='red';
                    $same.classList.remove('d-none');
                    $checkpassword.style.border = '1px red solid';
                    $password.style.border = '1px red solid';
                }
            }else{
                $same.classList.add('d-none');
                $checkpassword.style.border = 'none';
                $password.style.border = 'none';
                $checkpassword.style.borderBottom = '1px solid #D9D9D9';
                $password.style.borderBottom = '1px solid #D9D9D9';
            }

        }

        $password.addEventListener('focus',() => {
            $password.value = '';
        })

        $checkpassword.addEventListener('focus',() => {
            $checkpassword.value = '';
        })


        function checkBirth(){

            let inputDate = $date.value;

            console.log(inputDate);

            const dateToken = inputDate.split('-');

            $birthY.value = dateToken[0];
            $birthM.value = dateToken[1];
            $birthD.value = dateToken[2];

            const date = new Date();

            const customDate = date.getFullYear() + '-' + (date.getMonth()+1) + '-' + date.getDate();

            console.log(customDate);

           if (customDate < inputDate){
                alert('현재보다 미래일 수 없습니다.');
               $birthY.value = '';
               $birthM.value = '';
               $birthD.value = '';
                return;
           }

        }

        $phone.addEventListener('input',()=>{
            if($phone.value.length == 3 || $phone.value.length == 8){
                $phone.value += '-';
            }
        })


        function join(){

            let form = setform();
            console.log(form.email);

            const condition = (!form.email) || (!form.name) || (!form.password) || (!form.birthYear) || (!form.birthMonth)
                || (!form.birthDay) || (!form.phone) || (!form.gender) ;

            console.log(condition);

            if (!condition){

                fetch("http://localhost:8080/view/users/join", {
                    method: 'post',
                    headers: {
                        'content-type': 'application/json'
                    },
                    body : JSON.stringify(form)
                }).then((response) => response.json())//읽어온 데이터를 json으로 변환
                    .then((json) => {
                        console.log(json.result);
                        if (json.result){
                            const Toast = Swal.mixin({
                                toast: true,
                                position: "top-end",
                                showConfirmButton: false,
                                timer: 3000,
                                timerProgressBar: true,
                                didOpen: (toast) => {
                                    toast.onmouseenter = Swal.stopTimer;
                                    toast.onmouseleave = Swal.resumeTimer;
                                }
                            });
                            Toast.fire({
                                icon: "success",
                                title: "회원 가입 완료!"
                            });
                        }
                    })

                location.replace('http://localhost:8080/view/users/joinComplete');

            }else{
                Swal.fire({
                    icon: "error",
                    title: "Oops...",
                    text: "필수 데이터를 모두 채워 주세요!",
                    footer: 'GIVE'
                });
            }


        }

        const Toast = Swal.mixin({
            toast: true,
            position: "top-end",
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true,
            didOpen: (toast) => {
                toast.onmouseenter = Swal.stopTimer;
                toast.onmouseleave = Swal.resumeTimer;
            }
        });




    </script>


</body>
</html>